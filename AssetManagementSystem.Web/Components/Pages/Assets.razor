@page "/assets"
@rendermode InteractiveServer
@inject AssetService AssetService

<PageTitle>Ativos</PageTitle>

<h1>💻 Ativos</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowCreateForm">
        ➕ Novo Ativo
    </button>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @statusClass alert-dismissible fade show" role="alert">
        @statusMessage
        <button type="button" class="btn-close" @onclick="() => statusMessage = null"></button>
    </div>
}

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-header">
            @(isEditing ? "✏️ Editar Ativo" : "➕ Novo Ativo")
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Nome</label>
                <input type="text" class="form-control" @bind="formDto.Name" />
            </div>
            <div class="mb-3">
                <label class="form-label">Número de Série</label>
                <input type="text" class="form-control" @bind="formDto.SerialNumber" />
            </div>
            <div class="mb-3">
                <label class="form-label">Tipo</label>
                <select class="form-select" @bind="formDto.Type">
                    <option value="0">Selecione...</option>
                    <option value="1">Notebook</option>
                    <option value="2">Monitor</option>
                    <option value="3">Periférico</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Valor (R$)</label>
                <input type="number" step="0.01" class="form-control" @bind="formDto.Value" />
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            <button class="btn btn-success" @onclick="SaveAsset">💾 Salvar</button>
            <button class="btn btn-secondary" @onclick="CancelForm">Cancelar</button>
        </div>
    </div>
}

@if (assets == null)
{
    <p>Carregando...</p>
}
else if (!assets.Any())
{
    <div class="alert alert-info">Nenhum ativo cadastrado.</div>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Nº Série</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var asset in assets)
            {
                <tr>
                    <td>@asset.Id</td>
                    <td>@asset.Name</td>
                    <td>@asset.SerialNumber</td>
                    <td>@GetTypeInPortuguese(asset.Type)</td>
                    <td>@asset.Value.ToString("C", new System.Globalization.CultureInfo("pt-BR"))</td>
                    <td>
                        @if (asset.Status == "Disponível")
                        {
                            <span class="badge bg-success">@asset.Status</span>
                        }
                        else if (asset.Status == "Em Uso")
                        {
                            <span class="badge bg-primary">@asset.Status</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">@asset.Status</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" @onclick="() => EditAsset(asset)" title="Editar">✏️</button>

                        @if (asset.Status == "Disponível")
                        {
                            <button class="btn btn-sm btn-secondary" @onclick="() => SetMaintenance(asset.Id)" title="Enviar para Manutenção">🔧</button>
                        }
                        @if (asset.Status == "Manutenção")
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => SetAvailable(asset.Id)" title="Liberar">✅</button>
                        }

                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteAsset(asset.Id)" title="Excluir">🗑️</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<AssetDto>? assets;
    private CreateAssetDto formDto = new();
    private bool showForm = false;
    private bool isEditing = false;
    private int editingId = 0;
    private string? errorMessage;
    private string? statusMessage;
    private string statusClass = "alert-info";

    protected override async Task OnInitializedAsync()
    {
        await LoadAssets();
    }

    private async Task LoadAssets()
    {
        assets = await AssetService.GetAllAsync();
    }

    private void ShowCreateForm()
    {
        formDto = new CreateAssetDto();
        isEditing = false;
        showForm = true;
        errorMessage = null;
        statusMessage = null;
    }

    private void EditAsset(AssetDto asset)
    {
        formDto = new CreateAssetDto
        {
            Name = asset.Name,
            SerialNumber = asset.SerialNumber,
            Type = asset.Type switch
            {
                "Notebook" => 1,
                "Monitor" => 2,
                "Peripheral" => 3,
                _ => 0
            },
            Value = asset.Value
        };
        editingId = asset.Id;
        isEditing = true;
        showForm = true;
        errorMessage = null;
        statusMessage = null;
    }

    private void CancelForm()
    {
        showForm = false;
        errorMessage = null;
    }

    private async Task SaveAsset()
    {
        try
        {
            HttpResponseMessage response;

            if (isEditing)
            {
                response = await AssetService.UpdateAsync(editingId, formDto);
            }
            else
            {
                response = await AssetService.CreateAsync(formDto);
            }

            if (response.IsSuccessStatusCode)
            {
                showForm = false;
                await LoadAssets();
                ShowStatus(isEditing ? "Ativo atualizado com sucesso!" : "Ativo criado com sucesso!", true);
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.Message ?? "Erro ao salvar ativo.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private async Task DeleteAsset(int id)
    {
        var response = await AssetService.DeleteAsync(id);
        if (response.IsSuccessStatusCode)
        {
            await LoadAssets();
            ShowStatus("Ativo excluído com sucesso!", true);
        }
        else
        {
            var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
            ShowStatus(error?.Message ?? "Erro ao excluir ativo.", false);
        }
    }

    private async Task SetMaintenance(int id)
    {
        var response = await AssetService.SetMaintenanceAsync(id);
        if (response.IsSuccessStatusCode)
        {
            await LoadAssets();
            ShowStatus("Ativo enviado para manutenção!", true);
        }
        else
        {
            var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
            ShowStatus(error?.Message ?? "Erro ao enviar para manutenção.", false);
        }
    }

    private async Task SetAvailable(int id)
    {
        var response = await AssetService.SetAvailableAsync(id);
        if (response.IsSuccessStatusCode)
        {
            await LoadAssets();
            ShowStatus("Ativo disponibilizado!", true);
        }
        else
        {
            var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
            ShowStatus(error?.Message ?? "Erro ao disponibilizar ativo.", false);
        }
    }

    private void ShowStatus(string message, bool success)
    {
        statusMessage = message;
        statusClass = success ? "alert-success" : "alert-danger";
        StateHasChanged();
    }

    private string GetTypeInPortuguese(string type)
    {
        return type switch
        {
            "Notebook" => "Notebook",
            "Monitor" => "Monitor",
            "Peripheral" => "Periférico",
            _ => type
        };
    }

    private class ErrorResponse
    {
        public string? Message { get; set; }
    }
}