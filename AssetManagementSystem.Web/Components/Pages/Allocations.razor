@page "/allocations"
@rendermode InteractiveServer
@inject AllocationService AllocationService
@inject AssetService AssetService
@inject UserService UserService

<PageTitle>Alocações</PageTitle>

<h1>📋 Alocações</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowAllocateForm">
        ➕ Nova Alocação
    </button>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @statusClass alert-dismissible fade show" role="alert">
        @statusMessage
        <button type="button" class="btn-close" @onclick="() => statusMessage = null"></button>
    </div>
}

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-header">➕ Alocar Ativo</div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Ativo (Disponíveis)</label>
                <select class="form-select" @bind="formDto.AssetId">
                    <option value="0">Selecione um ativo...</option>
                    @if (availableAssets != null)
                    {
                        @foreach (var asset in availableAssets)
                        {
                            <option value="@asset.Id">@asset.Name - @asset.SerialNumber</option>
                        }
                    }
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Usuário</label>
                <select class="form-select" @bind="formDto.UserId">
                    <option value="0">Selecione um usuário...</option>
                    @if (users != null)
                    {
                        @foreach (var user in users.Where(u => u.IsActive))
                        {
                            <option value="@user.Id">@user.Name - @user.Department</option>
                        }
                    }
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Observações</label>
                <textarea class="form-control" @bind="formDto.Notes" rows="2"></textarea>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            <button class="btn btn-success" @onclick="AllocateAsset">💾 Alocar</button>
            <button class="btn btn-secondary" @onclick="CancelForm">Cancelar</button>
        </div>
    </div>
}

@if (allocations == null)
{
    <p>Carregando...</p>
}
else if (!allocations.Any())
{
    <div class="alert alert-info">Nenhuma alocação registrada.</div>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Ativo</th>
                <th>Nº Série</th>
                <th>Usuário</th>
                <th>Data Alocação</th>
                <th>Data Devolução</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var allocation in allocations)
            {
                <tr>
                    <td>@allocation.Id</td>
                    <td>@allocation.AssetName</td>
                    <td>@allocation.AssetSerialNumber</td>
                    <td>@allocation.UserName</td>
                    <td>@allocation.AllocatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        @if (allocation.ReturnedAt.HasValue)
                        {
                            @allocation.ReturnedAt.Value.ToString("dd/MM/yyyy HH:mm")
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        @if (allocation.IsActive)
                        {
                            <span class="badge bg-primary">Em Uso</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Devolvido</span>
                        }
                    </td>
                    <td>
                        @if (allocation.IsActive)
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => ReturnAsset(allocation.Id)" title="Devolver">
                                ↩️ Devolver
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<AllocationDto>? allocations;
    private List<AssetDto>? availableAssets;
    private List<UserDto>? users;
    private CreateAllocationDto formDto = new();
    private bool showForm = false;
    private string? errorMessage;
    private string? statusMessage;
    private string statusClass = "alert-info";

    protected override async Task OnInitializedAsync()
    {
        await LoadAllocations();
    }

    private async Task LoadAllocations()
    {
        allocations = await AllocationService.GetAllAsync();
    }

    private async Task ShowAllocateForm()
    {
        formDto = new CreateAllocationDto();
        availableAssets = await AssetService.GetAvailableAsync();
        users = await UserService.GetAllAsync();
        showForm = true;
        errorMessage = null;
        statusMessage = null;
    }

    private void CancelForm()
    {
        showForm = false;
        errorMessage = null;
    }

    private async Task AllocateAsset()
    {
        try
        {
            if (formDto.AssetId == 0)
            {
                errorMessage = "Selecione um ativo.";
                return;
            }
            if (formDto.UserId == 0)
            {
                errorMessage = "Selecione um usuário.";
                return;
            }

            var response = await AllocationService.AllocateAsync(formDto);

            if (response.IsSuccessStatusCode)
            {
                showForm = false;
                await LoadAllocations();
                ShowStatus("Ativo alocado com sucesso!", true);
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.Message ?? "Erro ao alocar ativo.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private async Task ReturnAsset(int allocationId)
    {
        var response = await AllocationService.ReturnAssetAsync(allocationId);

        if (response.IsSuccessStatusCode)
        {
            await LoadAllocations();
            ShowStatus("Ativo devolvido com sucesso!", true);
        }
        else
        {
            var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
            ShowStatus(error?.Message ?? "Erro ao devolver ativo.", false);
        }
    }

    private void ShowStatus(string message, bool success)
    {
        statusMessage = message;
        statusClass = success ? "alert-success" : "alert-danger";
        StateHasChanged();
    }

    private class ErrorResponse
    {
        public string? Message { get; set; }
    }
}